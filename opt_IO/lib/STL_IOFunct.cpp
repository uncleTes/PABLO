// ========================================================================== //
//                           - STL IO FUNCTIONS -                             //
//                                                                            //
// Input/Output function for STL format.                                      //
// ========================================================================== //
// INFO                                                                       //
// ========================================================================== //
// Author      :   Alessandro Alaia                                           //
// Version     :   v3.0                                                       //
//                                                                            //
// All rights reserved.                                                       //
// ========================================================================== //

// ========================================================================== //
// INCLUDES                                                                   //
// ========================================================================== //
# include "STL_IOFunct.hpp"

// ========================================================================== //
// IMPLEMENTATIONS                                                            //
// ========================================================================== //

// Class STL_obj methods ==================================================== //

// Constructors ------------------------------------------------------------- //

// -------------------------------------------------------------------------- //
STL_obj::STL_obj(
    void
) {

// ========================================================================== //
// STL_obj::STL_obj(                                                          //
//     void)                                                                  //
//                                                                            //
// Default constructor for class STL_obj variables.                           //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// SET DEFAULT VALUES                                                         //
// ========================================================================== //

// General info
stl_name = "";
stl_type = false;

// Error flags
err = 0;

// stl content
data.n_solids = -1;

return; };

// -------------------------------------------------------------------------- //
STL_obj::STL_obj(
    string  filename,
    bool    filetype
) {

// ========================================================================== //
// STL_obj::STL_obj(                                                          //
//     string  filename,                                                      //
//     bool    filetype)                                                      //
//                                                                            //
// Custom constructor #1 for class STL_obj variables.                         //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// SET DEFAULT VALUES                                                         //
// ========================================================================== //

// General info
stl_name = trim(filename);
stl_type = filetype;

// Error flags
err = 0;

// stl content
data.n_solids = -1;

return; };

// Public methods ----------------------------------------------------------- //

// -------------------------------------------------------------------------- //
void STL_obj::open(
    string  mode
) {

// ========================================================================== //
// void STL_obj::open(                                                        //
//     string)                                                                //
//                                                                            //
// Open stream to stl file.                                                   //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - mode       : string, stream mode:                                        //
//                "in", open an input stream (if not already opened)          //
//                "out", open an output stream in 'write' mode (if not        //
//                already opened). If an output stream is already open in a   //
//                different mode, then the output stream is closed and re-    //
//                opened in 'write' mode.                                     //
//                "app", open an output stream in 'append' mode (if not       //
//                already opened). If an output stream is already open in a   //
//                different mode, then the output stream is closed and re-    //
//                opened in 'append' mode.                                    //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// OPEN STREAM                                                                //
// ========================================================================== //

// Open input stream -------------------------------------------------------- //
if (mode.compare("in") == 0) {
    if (!ifile_handle.is_open()) {

        // Close output stream
        close("out");

        // Open input stream
        ifile_handle.open(stl_name, ifstream::in | ifstream::binary);

        // Check stream status
        if (!ifile_handle.good()) { err = 1; return; }
        else                      { err = 0; return; }

    }
}

// Open output stream in "write" mode --------------------------------------- //
else if (mode.compare("out") == 0) {
    if (!ofile_handle.is_open()) {

        // Close input stream
        close("in");

        // Clear infos & flags
        clear();

        // Open output stream
        if (stl_type) { ofile_handle.open(stl_name, ifstream::out | ifstream::binary); }
        else          { ofile_handle.open(stl_name, ifstream::out); }
    }

    // Check stream status
    if (!ofile_handle.good()) { err = 1; return; }
    else                      { err = 0; return; }
}

// Open output stream in "append" mode -------------------------------------- //
else if (mode.compare("app") == 0) {
    if (!ofile_handle.is_open()) {

        // Close input stream
        close("in");

        // Open output stream
        if (stl_type) { ofile_handle.open(stl_name, ifstream::app | ifstream::binary); }
        else          { ofile_handle.open(stl_name, ifstream::app); }
    }

    // Check stream status
    if (!ofile_handle.good()) { err = 1; return; }
    else                      { err = 0; return; }
}

return; };

// -------------------------------------------------------------------------- //
void STL_obj::close(
    string  mode
) {

// ========================================================================== //
// void STL_obj::close(                                                       //
//     string  mode)                                                          //
//                                                                            //
// Close stream to stl file.                                                  //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - mode        : string, stream mode to be closed (input/output/append)     //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// CLOSE STREAM                                                               //
// ========================================================================== //

// Close input stream ------------------------------------------------------- //
if (mode.compare("in") == 0) {
    ifile_handle.close();
}
else if (mode.compare("out") == 0) {
    ofile_handle.close();
}
else if (mode.compare("app") == 0) {
    ofile_handle.close();
}
else if (mode.compare("") == 0) {
    close("in");
    close("out");
}

return; };

// -------------------------------------------------------------------------- //
void STL_obj::clear(
    void
) {

// ========================================================================== //
// void STL_obj::clear(                                                       //
//     void)                                                                  //
//                                                                            //
// Clear infos and error flags in a class STL_obj variable.                   //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// RESET VALUES TO DEFAULT                                                    //
// ========================================================================== //

// Close input/output stream ------------------------------------------------ //
close();

// Set members values to default -------------------------------------------- //

// Error flags
err = 0;
stl_errors.resize(0);

// stl content
data.n_solids = -1;
data.solid_names.resize(0);
data.solid_facets.resize(0);

return; }

// -------------------------------------------------------------------------- //
void STL_obj::display(
    ostream     &out
) {

// ========================================================================== //
// void (STL_obj::display(                                                    //
//     ostream     &out)                                                      //
//                                                                            //
// Display infos about stl object.                                            //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - out       : ostream, output stream to redirect messages                  //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
int                 i;

// ========================================================================== //
// DISPLAY INFO                                                               //
// ========================================================================== //

// General info ------------------------------------------------------------- //
out << "STL object:" << endl;
out << "stl name          : " << stl_name << endl;
if (stl_type) { out << "file type         : binary" << endl; }
else          { out << "file type         : ASCII"  << endl; }
if (ifile_handle.is_open()) { out << "input stream      : open" << endl; }
else                        { out << "input stream      : closed" << endl; }
if (ofile_handle.is_open()) { out << "output stream     : open" << endl; }
else                        { out << "output stream     : closed" << endl; }

// Error flags -------------------------------------------------------------- //
if (err == 1) { out << "**ERROR** stl file is missing!" << endl; return; }

// Stl content -------------------------------------------------------------- //
if (data.n_solids >= 0) {
    out << "# of stl solids   : " << data.n_solids << endl;
    if (data.n_solids > 0) {
        out << "solid's name      : " << data.solid_names << endl;
        out << "# of facet        : " << data.solid_facets    << endl;
    }
}

// Errors ------------------------------------------------------------------- //

if ((data.n_solids >= 0) && (stl_errors.size() > 0)) {
    out << "ERROR report:" << endl;
    for (i = 0; i < data.n_solids; i++) {
        out << "  stl solid: '" << data.solid_names[i] << "'" << endl;
        if (stl_errors[i][0]) {
            out << "    **WARNING** unterminated solid block!!" << endl;
        }
        if (stl_errors[i][1]) {
            out << "    **WARNING** unterminated facet block!!" << endl;
        }
        if (stl_errors[i][2]) {
            out << "    **WARNING** normal data are missing!!" << endl;
        }
        if (stl_errors[i][3]) {
            out << "    **WARNING** wrong number of components for normal data!!" << endl;
        }
        if (stl_errors[i][4]) {
            out << "    **WARNING** wrong number of vertices in facet block!!" << endl;
        }
        if (stl_errors[i][5]) {
            out << "    **WARNING** wrong number of coordinates for vertices!!" << endl;
        }
    } //next i
}

return; };

// -------------------------------------------------------------------------- //
void STL_obj::scan(
    void
) {

// ========================================================================== //
// void STL_obj::scan(                                                        //
//     void)                                                                  //
//                                                                            //
// Scan stl object for infos.                                                 //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //
//  OUTPUT                                                                    //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// CLEAR INFOS                                                                //
// ========================================================================== //
clear();

// ========================================================================== //
// OPEN INPUT STREAM                                                          //
// ========================================================================== //
open("in");

// ========================================================================== //
// SCAN STL FILE                                                              //
// ========================================================================== //
if (stl_type) {
    err = Scan_STL_bin(ifile_handle, data.solid_names, data.solid_facets);
    data.n_solids = data.solid_names.size();
}
else {
    err = Scan_STL_ASCII(ifile_handle, data.solid_names, data.solid_facets);
    data.n_solids = data.solid_names.size();
}

// ========================================================================== //
// CLOSE INPUT STREAM                                                         //
// ========================================================================== //
close("in");

return; }

// -------------------------------------------------------------------------- //
void STL_obj::check(
    void
) {

// ========================================================================== //
// void STL_obj::check(                                                       //
//     void)                                                                  //
//                                                                            //
// Check errors in stl data structure.                                        //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// SCAN STL FILE                                                              //
// ========================================================================== //
scan();

// ========================================================================== //
// OPEN INPUT STREAM                                                          //
// ========================================================================== //
open("in");

// ========================================================================== //
// CHECK STL FILE                                                             //
// ========================================================================== //
if (stl_type) { Check_STL_bin(ifile_handle, stl_errors); }
else          { Check_STL_ASCII(ifile_handle, stl_errors); }

// ========================================================================== //
// CLOSE INPUT STREAM                                                         //
// ========================================================================== //
close("in");

return; };

// -------------------------------------------------------------------------- //
void STL_obj::load(
    int                       &nV,
    int                       &nT,
    dvector2D                 &V,
    dvector2D                 &N,
    ivector2D                 &T
) {

// ========================================================================== //
// void STL_obj::load(                                                        //
//     int                       &nV,                                         //
//     int                       &nT,                                         //
//     dvector2D                 &V,                                          //
//     dvector2D                 &N,                                          //
//     ivector2D                 &T)                                          //
//                                                                            //
// Load stl triangulation from stl file.                                      //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - nV                : int, number of stl vertices                          //
// - nT                : int, number of stl facets                            //
// - V                 : dvector2D, vertex coordinate list. V[i][0], V[i][1], //
//                       and V[i][2] are the x, y, z coordinates of the i-th  //
//                       vertex in the stl triangulation                      //
// - N                 : dvector2D, triangles normal. N[i][1], N[i][1],       //
//                       and N[i][2] are the x, y, z components of the normal //
//                       unit vector to the i-th triangle                     //
// - T                 : ivector2D, triangle-vertex connectivity. T[i][0],    //
//                       T[i][1], and T[i][2] are the global indices of       //
//                       vertices of the i-th triangle                        //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// OPEN INPUT STREAM                                                          //
// ========================================================================== //
open("in");
if (err == 1) { return; }

// ========================================================================== //
// READ STL DATA                                                              //
// ========================================================================== //
if (stl_type)   { Read_STL_bin(ifile_handle, nV, nT, V, N, T); }
else            { Read_STL_ASCII(ifile_handle, nV, nT, V, N, T); }

// ========================================================================== //
// CLOSE INPUT STREAM                                                         //
// ========================================================================== //
close("in");

return; };

// Private methods ---------------------------------------------------------- //

// -------------------------------------------------------------------------- //
void STL_obj::save(
    void
) {

// ========================================================================== //
// void STL_obj::save(                                                        //
//     void)                                                                  //
//                                                                            //
// Dummy function for self-recursive variadic template.                       //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// CLOSE OUTPUT STREAM                                                        //
// ========================================================================== //
close("out");

return; };

// -------------------------------------------------------------------------- //
void STL_obj::load(
    void
) {

// ========================================================================== //
// void STL_obj::load(                                                        //
//     void)                                                                  //
//                                                                            //
// Dummy function for self-recursive variadic template "load".                //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - none                                                                     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
// none

// Counters
// none

// ========================================================================== //
// CLOSE INPUT STREAM                                                         //
// ========================================================================== //
close("in");

return; };

// Scanning routines ======================================================== //

// -------------------------------------------------------------------------- //
unsigned int Scan_STL_ASCII(
    ifstream                  &file_handle,
    svector1D                 &solid_names,
    ivector1D                 &solid_facets
) {

// ========================================================================== //
// unsigned int Scan_STL_ASCII(                                               //
//     ifstream                  &file_handle,                                //
//     svector1D                 &solid_names,                                //
//     ivector1D                 &solid_facets)                               //
//                                                                            //
// Scan STL solid and returns infos for each stl solid,                       //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle      : ifstream, input stream to ASCII stl file.             //
// - solid_names      : svector1D, solid names.                               //
// - solid_facets     : ivector1D, number of facets for each solid.           //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err              : unsigned int, error flag:                             //
//                      err = 0     --> no errors encountered                 //
//                      err = 1     --> file not found or corrupted.          //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int             start_pos;
string               line, word;
stringstream         sline, sword;

// Counters
int                  nF = 0;

// ========================================================================== //
// RESIZE INPUT VARIABLES                                                     //
// ========================================================================== //
solid_names.resize(0);
solid_facets.resize(0);

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) {
    return(1);
}

// ========================================================================== //
// RESET CURSOR AT FILE BEGIN                                                 //
// ========================================================================== //
file_handle.clear();
start_pos = file_handle.tellg();
file_handle.seekg(0);

// ========================================================================== //
// SCAN STL FILE.                                                             //
// ========================================================================== //

// Set cursor position at file begin ---------------------------------------- //
file_handle.clear();
file_handle.seekg(0);

// Scan until eof is reached
while (!file_handle.eof()) {

    // Get current line
    getline(file_handle, line);
    line = trim(line);
    sline.clear();
    sline.str(line);

    // Get keyword
    if (sline >> word) {
        if (word.compare("solid") == 0) {

            // Reset counters
            nF = 0;

            // Get solid name
            sword.str("");
            while (sline >> word) {
                sword << word << " ";
            }
            word = sword.str();
            solid_names.push_back(trim(word));

            // Get solid info
            Scan_STLsolid_ASCII(file_handle, nF);
            solid_facets.push_back(nF);
            
        }
    }

} //next line

// Restore cursor position -------------------------------------------------- //
file_handle.clear();
file_handle.seekg(start_pos);

return(0); };

// -------------------------------------------------------------------------- //
unsigned int Scan_STL_bin(
    ifstream                  &file_handle,
    svector1D                 &solid_names,
    ivector1D                 &solid_facets
) {

// ========================================================================== //
// unsigned int Scan_STL_bin(                                                 //
//     ifstream                  &file_handle,                                //
//     svector1D                 &solid_names,                                //
//     ivector1D                 &solid_facets)                               //
//                                                                            //
// Scan binary stl file and returns infos.                                    //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle      : ifstream, input stream to ASCII stl file.             //
// - solid_names      : svector1D, solid names.                               //
// - solid_facets     : ivector1D, number of facets for each solid.           //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err              : unsigned int, error flag:                             //
//                      err = 0     --> no errors encountered                 //
//                      err = 1     --> file not found or corrupted.          //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int           start_pos = file_handle.tellg();
unsigned long int  longint4byte;
unsigned long int *longint4byte_ = &longint4byte;
float              float4byte;
float             *float4byte_   = &float4byte;

// Counters
int                i;

// ========================================================================== //
// RESIZE INPUT VARIABLES                                                     //
// ========================================================================== //
solid_names.resize(0);
solid_facets.resize(0);

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) { return(1); };

// ========================================================================== //
// SCAN STL FILE                                                              //
// ========================================================================== //

// Set cursor position at file begin
file_handle.seekg(0);

// Get solid name
for (i = 0; i < 20; i++) {
    file_handle.read(reinterpret_cast<char*>(float4byte_), 4);
} //next i
solid_names.push_back("");

// Read number of facets
file_handle.read(reinterpret_cast<char*>(longint4byte_), 4);
solid_facets.push_back((int)*longint4byte_);

// Reset cursor position
file_handle.clear();
file_handle.seekg(start_pos);

return(0); };

// -------------------------------------------------------------------------- //
unsigned int Scan_STLsolid_ASCII(
    ifstream                  &file_handle,
    int                       &nT
) {

// ========================================================================== //
// unsigned int Scan_STLsolid_ASCII(                                          //
//     ifstream                  &file_handle,                                //
//     int                       &nT)                                         //
//                                                                            //
// Scan stl solid from ASCII stl file and returns the number of facets.       //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle    : ifstream, input stream to stl file                      //
// - nT             : int, number of triangles                                //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err            : unsigned int, error flag:                               //
//                    err = 0     --> no errors encountered                   //
//                    err =       -->                                         //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int        backup_pos;
string          line, word;
stringstream    sline;

// Counters
// none

// ========================================================================== //
// RESET COUNTERS                                                             //
// ========================================================================== //
nT = 0;

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) { return(1); };

// ========================================================================== //
// SCAN STL SOLID                                                             //
// ========================================================================== //

// Get current line
backup_pos = file_handle.tellg();
getline(file_handle, line);
line = trim(line);
sline.clear();
sline.str(line);
if (!(sline >> word)) { word = ""; }

// Scan lines until eof or keyword "endsolid" is found
while ((!file_handle.eof())
    && ((word.compare("endsolid") != 0)
    &&  (word.compare("solid") != 0))) {

    // Look for keyword "facet"
    if (word.compare("facet") == 0) {
        nT++;
    }

    // Get next line
    backup_pos = file_handle.tellg();
    getline(file_handle, line);
    line = trim(line);
    sline.clear();
    sline.str(line);
    if (!(sline >> word))  { word = ""; }

} //next line
if (word.compare("endsolid") != 0) {
    file_handle.clear();
    file_handle.seekg(backup_pos);
}


return(0); };

// Check routines =========================================================== //

// -------------------------------------------------------------------------- //
unsigned int Check_STL_ASCII(
    ifstream                  &file_handle,
    bvector2D                 &err_map
) {

// ========================================================================== //
// unsigned int Check_STL_ASCII(                                              //
//     ifstream                  &file_handle,                                //
//     bvector2D                 &err_map)                                    //
//                                                                            //
// Check errors in a ASCII stl file.                                          //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle : ifstream, input stream to stl file.                        //
// - err_map     : bvector2D, list of errors encountered for each solid block //
//                 while checking stl file.                                   //
//                 err_map[i][err_code] for the i-th stl solid is true        //
//                 if an error corresponding to error code "err_code"         //
//                 is detected.                                               //
//                 err_code = 0   --> unterminated solid block                //
//                 err_code = 1   --> unterminated facet block                //
//                 err_code = 2   --> normal data are missing                 //
//                 err_code = 3   --> wrong number of components for normal   //
//                 err_code = 4   --> wrong number of vertices in facet block //
//                 err_code = 5   --> wrong number of coordinates for vertex  //
//                                    data.                                   //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err         : unsigned int, error flag:                                  //
//                 err = 0  --> no errors encountered                         //
//                 err = 1  --> file is missing or is corrupted               //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int            start_pos = file_handle.tellg();
string              line, word;
stringstream        sline;

// Counters
int                 n_solid = 0;

// ========================================================================== //
// RESIZE INPUT VARIABLES                                                     //
// ========================================================================== //
err_map.resize(0);

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) { return(1); };

// ========================================================================== //
// CHECK STL FILE                                                             //
// ========================================================================== //

// Set cursor position at file begin
file_handle.clear();
file_handle.seekg(0);

// Scan stl solid
while (getline(file_handle, line)) {

    // Get current line
    line = trim(line);
    sline.clear(),
    sline.str(line);

    if ((sline >> word) && (word.compare("solid") == 0)) {
        bvector1D       _map(6, false);
        n_solid++;
        Check_STLsolid_ASCII(file_handle, _map);
        err_map.push_back(_map);
    }

} //next line

// Reset cursor position
file_handle.clear();
file_handle.seekg(start_pos);

return(0); }

// -------------------------------------------------------------------------- //
unsigned int Check_STLsolid_ASCII(
    ifstream                  &file_handle,
    bvector1D                 &err_map
) {

// ========================================================================== //
// unsigned int Check_STLsolid_ASCII(                                         //
//     ifstream                  &file_handle,                                //
//     bvector1D                 &err_map)                                    //
//                                                                            //
// Check errors in solid data of ASCII stl file.                              //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle : ifstream, input stream to stl file.                        //
// - err_map     : bvector1D, list of errors encountered while checking stl   //
//                 file. err_map[err_code] is true if error corresponding to  //
//                 error code "err_code" is detected.                         //
//                 err_code = 0   --> unterminated solid block                //
//                 err_code = 1   --> unterminated facet block                //
//                 err_code = 2   --> normal data are missing                 //
//                 err_code = 3   --> wrong number of components for normal   //
//                 err_code = 4   --> wrong number of vertices in facet block //
//                 err_code = 5   --> wrong number of coordinates for vertex  //
//                                    data.                                   //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err         : unsigned int, error flag:                                  //
//                 err = 0  --> no errors encountered                         //
//                 err = 1  --> file is missing or is corrupted               //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int            backup_pos;
string              line, word;
stringstream        sline;

// Counters
// none

// ========================================================================== //
// RESIZE INPUT VARIABLES                                                     //
// ========================================================================== //
err_map.resize(6, false);

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) { return(1); }

// ========================================================================== //
// SCAN SOLID DATA                                                            //
// ========================================================================== //

// Get current line
backup_pos = file_handle.tellg();
getline(file_handle, line);
line = trim(line);
sline.clear();
sline.str(line);
if (!(sline >> word)) { word = ""; }

// Scan stl solid data until eof or keyword "endsolid" is found
while ((!file_handle.eof())
    && ((word.compare("endsolid") != 0) 
    &&  (word.compare("solid")    != 0))) {

        // Look for keyword "facet"
        if (word.compare("facet") == 0) {
            file_handle.seekg(backup_pos);
            Check_STLfacet_ASCII(file_handle, err_map);
        }

        // Get next line
        backup_pos = file_handle.tellg();
        getline(file_handle, line);
        line = trim(line);
        sline.clear();
        sline.str(line);
        if (!(sline >> word)) { word = ""; }

} //next line

// Check block temination
if (word.compare("endsolid") != 0) {
    err_map[0] = true;
    file_handle.clear();
    file_handle.seekg(backup_pos);
};

return(0); };

// -------------------------------------------------------------------------- //
unsigned int Check_STLfacet_ASCII(
    ifstream                  &file_handle,
    bvector1D                 &err_map
) {

// ========================================================================== //
// unsigned int Check_STLfacet_ASCII(                                         //
//     ifstream                  &file_handle,                                //
//     bvector1D                 &err_map)                                    //
//                                                                            //
// Check errors in facet data of ASCII stl file.                              //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle : ifstream, input stream to stl file.                        //
// - err_map     : bvector1D, list of errors encountered while checking stl   //
//                 file. err_map[err_code] is true if error corresponding to  //
//                 error code "err_code" is detected.                         //
//                 err_code = 0   --> unterminated solid block                //
//                 err_code = 1   --> unterminated facet block                //
//                 err_code = 2   --> normal data are missing                 //
//                 err_code = 3   --> wrong number of components for normal   //
//                 err_code = 4   --> wrong number of vertices in facet block //
//                 err_code = 5   --> wrong number of coordinates for vertex  //
//                                    data.                                   //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err         : unsigned int, error flag:                                  //
//                 err = 0  --> no errors encountered                         //
//                 err = 1  --> file is missing or is corrupted               //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
bool            check_normal = false;
long int        backup_pos;
string          line, word;
stringstream    sline;

// Counters
int             nxyz = 0, nV = 0;

// ========================================================================== //
// RESIZE INPUT VARIABLES                                                     //
// ========================================================================== //
err_map.resize(6, false);

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) { return(1); }

// ========================================================================== //
// SCAN FACET DATA                                                            //
// ========================================================================== //

// Get current line --------------------------------------------------------- //
backup_pos = file_handle.tellg();
getline(file_handle, line);
line = trim(line);
sline.clear(),
sline.str(line);
if ((!(sline >> word)) || (word.compare("facet") == 0)) { word = "begin"; }

// Scan facet data until eof or keyword "endfacet" is found ----------------- //
while ((!file_handle.eof()) &&
    ((word.compare("endfacet")  != 0)
  && (word.compare("facet")     != 0)
  && (word.compare("endsolid")  != 0)
  && (word.compare("solid")     != 0))) {

    // Check facet normal
    if (word.compare("begin") == 0) {
        if ((sline >> word) && (word.compare("normal") == 0)) {
            check_normal = true;
            nxyz = 0;
            while (sline >> word) {
                nxyz++;
            } //next field
            if (nxyz != 3) { err_map[3] = true; }
        }
    }
    else if (word.compare("vertex") == 0) {
        nV++;
        nxyz = 0;
        while (sline >> word) {
            nxyz++;
        } //next field
        if (nxyz != 3) { err_map[5] = true; }
    }

    // Get next line
    backup_pos = file_handle.tellg();
    getline(file_handle, line);
    line = trim(line);
    sline.clear(),
    sline.str(line);
    if (!(sline >> word)) { word = ""; }

} //next line

// Check error status

// Block termination
if (word.compare("endfacet") != 0) {
    err_map[1] = true;
    file_handle.clear(),
    file_handle.seekg(backup_pos);
}

// Normal data
if (!check_normal) { err_map[2] = true; }

// Number of vertices
if (nV != 3) { err_map[4] = true; }


return(0); }

// -------------------------------------------------------------------------- //
unsigned int Check_STL_bin(
    ifstream                  &file_handle,
    bvector2D                 &err_map
) {

// ========================================================================== //
// unsigned int Check_STL_bin(                                                //
//     ifstream                  &file_handle,                                //
//     bvector2D                 &err_map)                                    //
//                                                                            //
// Check data consistency in binary stl files.                                //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle : ifstream, input stream to stl file                         //
// - err_map     : bvector2D, list of errors encountered for each solid block //
//                 while checking stl file.                                   //
//                 err_map[i][err_code] for the i-th stl solid is true        //
//                 if an error corresponding to error code "err_code"         //
//                 is detected.                                               //
//                 err_code = 0   --> unterminated solid block                //
//                 err_code = 1   --> unterminated facet block                //
//                 err_code = 2   --> normal data are missing                 //
//                 err_code = 3   --> wrong number of components for normal   //
//                 err_code = 4   --> wrong number of vertices in facet block //
//                 err_code = 5   --> wrong number of coordinates for vertex  //
//                                    data.                                   //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err         : unsigned int, error flag:                                  //
//                 err = 0     --> no errors encountered                      //
//                 err = 1     --> file is missing or is corrupted            //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int           start_pos = file_handle.tellg();
unsigned int       int2byte;
unsigned int      *int2byte_ = &int2byte;
unsigned long int  longint4byte;
unsigned long int *longint4byte_ = &longint4byte;
float              float4byte;
float             *float4byte_   = &float4byte;

// Counters
int                i, j, k, nT;

// ========================================================================== //
// RESIZE INPUT VARIABLES                                                     //
// ========================================================================== //
err_map.resize(1, bvector1D(6, false));

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) { return(1); }

// ========================================================================== //
// CHECK STL FILE                                                             //
// ========================================================================== //

// Check file header -------------------------------------------------------- //
for (i = 0; i < 20; i++) {
    file_handle.read(reinterpret_cast<char*>(float4byte_), 4);
} //next i
if (file_handle.eof()) {
    err_map[0][0] = true;
    return(0);
}

// Check number of facets --------------------------------------------------- //
file_handle.read(reinterpret_cast<char*>(longint4byte_), 4);
nT = (int)*longint4byte_;
if (file_handle.eof()) {
    err_map[0][0] = true;
    return(0);
}

// Check facet data --------------------------------------------------------- //
i = 0;
while ((!file_handle.eof()) && (i < nT)) {

    // Read normal
    for (j = 0; j < 3; j++) {
        file_handle.read(reinterpret_cast<char*>(float4byte_), 4);
    } //next j

    // Read vertex coordinates
    for (j = 0; j < 3; j++) {
        for (k = 0; k < 3; k++) {
            file_handle.read(reinterpret_cast<char*>(float4byte_), 4);
        } //next k
    } //next j

    // Facet closing header
    file_handle.read(reinterpret_cast<char*>(int2byte_), 2);

    // Update facet counter
    i++;

} //next i

// Check error status ------------------------------------------------------- //
if (i < nT) { err_map[0][1] = true; };


return(0); }

// Input routines =========================================================== //

// -------------------------------------------------------------------------- //
unsigned int Read_STLfacet_ASCII(
    ifstream                  &file_handle,
    int                       &nV,
    int                       &nT,
    dvector2D                 &V,
    dvector2D                 &N,
    ivector2D                 &T
) {

// ========================================================================== //
// unsigned int Read_STLfacet_ASCII(                                          //
//     ifstream                  &file_handle,                                //
//     int                       &nV,                                         //
//     int                       &nT,                                         //
//     dvector2D                 &V,                                          //
//     dvector2D                 &N,                                          //
//     ivector2D                 &T)                                          //
//                                                                            //
// Read stl facet data from ASCII stl file.                                   //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle       : ifstream, handle to stl file                         //
// - nV                : int, number of stl vertices                          //
// - nT                : int, number of stl facets                            //
// - V                 : dvector2D, vertex coordinate list. V[i][0], V[i][1], //
//                       and V[i][2] are the x, y, z coordinates of the i-th  //
//                       vertex in the stl triangulation                      //
// - N                 : dvector2D, triangles normal. N[i][1], N[i][1],       //
//                       and N[i][2] are the x, y, z components of the normal //
//                       unit vector to the i-th triangle                     //
// - T                 : ivector2D, triangle-vertex connectivity. T[i][0],    //
//                       T[i][1], and T[i][2] are the global indices of       //
//                       vertices of the i-th triangle                        //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err               : unsigned int, error flag                             //
//                       err = 0    --> no errors encountered                 //
//                       err = 1    --> file is missing or cannot be open     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int            cursor_pos;
string              line, word;
stringstream        sline;

// Counters
int                 nv = 0;

// ========================================================================== //
// READ FACET DATA                                                            //
// ========================================================================== //

// Read facet data ---------------------------------------------------------- //

// Get current line
cursor_pos = file_handle.tellg();
getline(file_handle, line);
line = trim(line);
sline.clear();
sline.str(line);
if ((!(sline >> word)) || (word.compare("facet") == 0)) { word = "begin"; }

// Loop until end of facet is found
while ((!file_handle.eof())
    && ((word.compare("endfacet")   != 0)
    &&  (word.compare("facet")      != 0)
    &&  (word.compare("solid")      != 0)
    &&  (word.compare("endsolid")   != 0))) {

    // Look for keywords
    if (word.compare("begin") == 0) {
        if ((sline >> word) && (word.compare("normal") == 0)) {
            sline >> N[nT];
        }
    }
    else if (word.compare("vertex") == 0) {
        sline >> V[nV+nv];
        nv++;
    }

    // Get next line
    cursor_pos = file_handle.tellg();
    getline(file_handle, line);
    line = trim(line);
    sline.clear();
    sline.str(line);
    if (!(sline >> word)) { word = ""; }

} //next line

// Restor cursor position --------------------------------------------------- //
if (word.compare("endfacet") != 0) {
    file_handle.clear();
    file_handle.seekg(cursor_pos);
}

// Update triangle-vertex connectivity -------------------------------------- //
for (int i = 0; i < nv; i++) {
    T[nT][i] = nV + i;
} //next i

// Update facet/vertex counters --------------------------------------------- //
nV += 3;
nT++;

return(0); }

// -------------------------------------------------------------------------- //
unsigned int Read_STLsolid_ASCII(
    ifstream                  &file_handle,
    int                       &nV,
    int                       &nT,
    dvector2D                 &V,
    dvector2D                 &N,
    ivector2D                 &T,
    string                     solid_name
) {

// ========================================================================== //
// unsigned int Read_STLsolid_ASCII(                                          //
//     ifstream                  &file_handle,                                //
//     int                       &nV,                                         //
//     int                       &nT,                                         //
//     dvector2D                 &V,                                          //
//     dvector2D                 &N,                                          //
//     ivector2D                 &T,                                          //
//     string                     solid_name)                                 //
//                                                                            //
// Load stl triangulation for stl solid whose name is specified in            //
// "solid_name". Vertex ccordinate list, triangles normals and connectivity   //
// are stored in V, N and T respectively. If no solid is found input data     //
// structure is unchanged.                                                    //
// If solid_name is not specified, load the first stl solid found by circular //
// scanning the file until the current cursor position is reached again.      //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle       : ifstream, handle to stl file                         //
// - nV                : int, number of stl vertices                          //
// - nT                : int, number of stl facets                            //
// - V                 : dvector2D, vertex coordinate list. V[i][0], V[i][1], //
//                       and V[i][2] are the x, y, z coordinates of the i-th  //
//                       vertex in the stl triangulation                      //
// - N                 : dvector2D, triangles normal. N[i][1], N[i][1],       //
//                       and N[i][2] are the x, y, z components of the normal //
//                       unit vector to the i-th triangle                     //
// - T                 : ivector2D, triangle-vertex connectivity. T[i][0],    //
//                       T[i][1], and T[i][2] are the global indices of       //
//                       vertices of the i-th triangle                        //
// - solid_name        : string (optional), stl solid name                    //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err               : unsigned int, error flag                             //
//                       err = 0    --> no errors encountered                 //
//                       err = 1    --> file is missing or cannot be open     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
bool                check = false;
long int            start_pos = file_handle.tellg(), current_pos, end_pos;
string              line, word;
stringstream        sline;

// Counters
int                 nv, nt;

// ========================================================================== //
// CHECK INPUT STREAM                                                         //
// ========================================================================== //
if (!file_handle.good()) { return(1); }

// ========================================================================== //
// SCAN STL FILE UNTIL A SOLID IS FOUND                                       //
// ========================================================================== //

// Parameters --------------------------------------------------------------- //
sline << "solid " << solid_name;
line = sline.str();
solid_name = trim(line);

// Scan file until stl solid is found --------------------------------------- //
current_pos = start_pos+1;
while (!check && (start_pos != current_pos)) {

    // Get current line
    getline(file_handle, line);
    line = trim(line);
    sline.clear();
    sline.str(line);

    // Check end of file
    if (file_handle.eof()) {
        file_handle.clear();
        file_handle.seekg(0);
    }
    current_pos = file_handle.tellg();

    // Look for keyword "solid"
    if ((sline >> word) && (word.compare("solid") == 0)) {
        if (solid_name.compare("solid") == 0) {
            start_pos = current_pos;
            check = true;
        }
        else {
            if (line.compare(solid_name) == 0) {
                start_pos = current_pos;
                check = true;
            }
        }
    }

} //next line
if (!check) { return(0); }

// Scan stl solid ----------------------------------------------------------- //
file_handle.clear();
file_handle.seekg(start_pos);
Scan_STLsolid_ASCII(file_handle, nt);

// ========================================================================== //
// READ SOLID DATA                                                            //
// ========================================================================== //

// Resize input variables --------------------------------------------------- //
V.resize(nV+3*nt, dvector1D(3, 0.0));
N.resize(nT+nt, dvector1D(3, 0.0));
T.resize(nT+nt, ivector1D(3, -1));

// Read solid data ---------------------------------------------------------- //
file_handle.clear();
file_handle.seekg(start_pos);
word = "begin";
while ((!file_handle.eof())
    && (word.compare("endsolid") != 0)
    && (word.compare("solid") != 0)) {

    // Get current line
    current_pos = file_handle.tellg();
    getline(file_handle, line);
    line = trim(line);
    sline.clear();
    sline.str(line);

    // Look for keyword "facet"
    if ((sline >> word) && (word.compare("facet") == 0)) {
        file_handle.seekg(current_pos);
        Read_STLfacet_ASCII(file_handle, nV, nT, V, N, T);
    }
} //next line
if (word.compare("endsolid") != 0) {
    file_handle.clear();
    file_handle.seekg(current_pos);
}

return(0); }

// -------------------------------------------------------------------------- //
unsigned int Read_STL_ASCII(
    ifstream                  &file_handle,
    int                       &nV,
    int                       &nT,
    dvector2D                 &V,
    dvector2D                 &N,
    ivector2D                 &T
) {

// ========================================================================== //
// unsigned int Read_STL_ASCII(                                               //
//     ifstream                  &file_handle,                                //
//     int                       &nV,                                         //
//     int                       &nT,                                         //
//     dvector2D                 &V,                                          //
//     dvector2D                 &N,                                          //
//     ivector2D                 &T)                                          //
//                                                                            //
// Read stl solid data from binary stl file.                                  //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle       : ifstream, handle to stl file                         //
// - nV                : int, number of stl vertices                          //
// - nT                : int, number of stl facets                            //
// - V                 : dvector2D, vertex coordinate list. V[i][0], V[i][1], //
//                       and V[i][2] are the x, y, z coordinates of the i-th  //
//                       vertex in the stl triangulation                      //
// - N                 : dvector2D, triangles normal. N[i][1], N[i][1],       //
//                       and N[i][2] are the x, y, z components of the normal //
//                       unit vector to the i-th triangle                     //
// - T                 : ivector2D, triangle-vertex connectivity. T[i][0],    //
//                       T[i][1], and T[i][2] are the global indices of       //
//                       vertices of the i-th triangle                        //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err               : unsigned int, error flag                             //
//                       err = 0    --> no errors encountered                 //
//                       err = 1    --> file is missing or cannot be open     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int        start_pos, current_pos;
stringstream    sline;
string          line, word;

// Counters
// none

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) { return(0); }

// ========================================================================== //
// SET CURSOR POSITION AT FILE BEGIN                                          //
// ========================================================================== //
file_handle.clear();
start_pos = file_handle.tellg();
file_handle.seekg(0);

// ========================================================================== //
// LOAD STL SOLIDS                                                            //
// ========================================================================== //
//while (!file_handle.eof()) {
current_pos = 0;
while (getline(file_handle, line)) {

    // Get current line
    sline.clear();
    sline.str(line);
    if ((sline >> word) && (word.compare("solid") == 0)) {
        file_handle.clear();
        file_handle.seekg(current_pos);
        Read_STLsolid_ASCII(file_handle, nV, nT, V, N, T, "");
    }
    current_pos = file_handle.tellg();
}
//} //next solid

// ========================================================================== //
// RESET CURSOR POSITION AT FILE BEGIN                                        //
// ========================================================================== //
file_handle.clear();
file_handle.seekg(start_pos);

return(0); }

// -------------------------------------------------------------------------- //
unsigned int Read_STL_bin(
    ifstream                  &file_handle,
    int                       &nV,
    int                       &nT,
    dvector2D                 &V,
    dvector2D                 &N,
    ivector2D                 &T
) {

// ========================================================================== //
// unsigned int Read_STL_bin(                                                 //
//     ifstream                  &file_handle,                                //
//     int                       &nV,                                         //
//     int                       &nT,                                         //
//     dvector2D                 &V,                                          //
//     dvector2D                 &N,                                          //
//     ivector2D                 &T)                                          //
//                                                                            //
// Read stl solid data from binary stl file.                                  //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle       : ifstream, handle to stl file                         //
// - nV                : int, number of stl vertices                          //
// - nT                : int, number of stl facets                            //
// - V                 : dvector2D, vertex coordinate list. V[i][0], V[i][1], //
//                       and V[i][2] are the x, y, z coordinates of the i-th  //
//                       vertex in the stl triangulation                      //
// - N                 : dvector2D, triangles normal. N[i][1], N[i][1],       //
//                       and N[i][2] are the x, y, z components of the normal //
//                       unit vector to the i-th triangle                     //
// - T                 : ivector2D, triangle-vertex connectivity. T[i][0],    //
//                       T[i][1], and T[i][2] are the global indices of       //
//                       vertices of the i-th triangle                        //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err               : unsigned int, error flag                             //
//                       err = 0    --> no errors encountered                 //
//                       err = 1    --> file is missing or cannot be open     //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
long int           start_pos;
unsigned long int  longint4byte;
unsigned int       int2byte;
float              float4byte;
unsigned int      *int2byte_pointer     = &int2byte;
unsigned long int *longint4byte_pointer = &longint4byte;
float             *float4byte_pointer   = &float4byte;

// Counters
int                i, j, k;

// ========================================================================== //
// CHECK STREAM STATUS                                                        //
// ========================================================================== //
if (!file_handle.good()) {
    file_handle.close();
    return(1);
}

// ========================================================================== //
// SET CURSOR POSITION AT FILE BEGIN                                          //
// ========================================================================== //
file_handle.clear();
start_pos = file_handle.tellg();
file_handle.seekg(0);

// ========================================================================== //
// SCAN BINARY STL                                                            //
// ========================================================================== //

// Title
for (i = 0; i < 20; i++) {
    file_handle.read(reinterpret_cast<char*>(float4byte_pointer), 4);
} //next i

// Read number of elements
file_handle.read(reinterpret_cast<char*>(longint4byte_pointer), 4);
nT = (int)*longint4byte_pointer;
nV = 3*nT;

// ========================================================================== //
// RESIZE INPUT VARIABLES                                                     //
// ========================================================================== //

// Vertex list
V.resize(nV, dvector1D(3, 0.0));

// Normals
N.resize(nT, dvector1D(3, 0.0));

// Triangle-vector connectivity
T.resize(nT, ivector1D(3, -1));

// ========================================================================== //
// READ DATA                                                                  //
// ========================================================================== //
nV = 0;
for (i = 0; i < nT; i++) {

    // Read normal
    for (j = 0; j < 3; j++) {
        file_handle.read(reinterpret_cast<char*>(float4byte_pointer), 4);
        N[i][j] = (double)*float4byte_pointer;
    } //next j

    // Read vertex coordinates
    for (j = 0; j < 3; j++) {
        for (k = 0; k < 3; k++) {
            file_handle.read(reinterpret_cast<char*>(float4byte_pointer), 4);
            V[nV][k] = (double)*float4byte_pointer;
        } //next k
        nV++;
    } //next j

    // Triangle-vertex connectivity
    T[i][0] = nV - 3;
    T[i][1] = nV - 2;
    T[i][2] = nV - 1;

    // Facet closing header
    file_handle.read(reinterpret_cast<char*>(int2byte_pointer), 2);

} //next i

// ========================================================================== //
// RESET CURSOR POSITION                                                      //
// ========================================================================== //
file_handle.clear();
file_handle.seekg(start_pos);

return(0); }

// Output routines ========================================================== //

// -------------------------------------------------------------------------- //
unsigned int Write_STLsolid_ASCII(
    ofstream                  &file_handle,
    int                       &nV,
    int                       &nT,
    dvector2D                 &V,
    dvector2D                 &N,
    ivector2D                 &T,
    string                     solid_name
) {

// ========================================================================== //
// unsigned int Write_STLsolid_ASCII(                                         //
//     ofstream                  &file_handle,                                //
//     int                       &nV,                                         //
//     int                       &nT,                                         //
//     dvector2D                 &V,                                          //
//     dvector2D                 &N,                                          //
//     ivector2D                 &T,                                          //
//     string                     solid_name)                                 //
//                                                                            //
// Write a stl solid in a ASCII .stl file.                                    //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle : ofstream, output stream                                    //
// - nV          : int, number of triangulation vertices                      //
// - nT          : int, number of triangles in the stl triangulation          //
// - V           : dvector2D, vertex coordinate list. V[i][0], V[i][1] and    //
//                 V[i][2] are the x, y, z coordinates of the i-th vertex     //
// - N           : dvector2D, triangles unit normals. N[i][0], N[i][1], and   //
//                 N[i][2] are the x, y, z components of the normal unit      //
//                 vector to the i-th triangle of the stl triangulation.      //
// - T           : ivector2D, triangle-vertex connectivity. T[i][0], T[i][1]  //
//                 and T[i][2] are the global indices of vertices of the i-th //
//                 triangle in the stl triangulation                          //
// - solid_name  : string (optional) stl solid name                           //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err         : int, output flag:                                          //
//                 err = 0      --> no errors encountered                     //
//                 err = 1      --> file is missing or cannot be accessed     //
//                 err = 2      --> input data are badly formatted            //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
stringstream     sheader;
string           header;
unsigned int     err = 0;

// Counters
int              n, m, i, j, k;

// =========================================================================== //
// CHECK INPUT COHERENCY                                                       //
// =========================================================================== //
if (V.size() < nV)  { return(2); };
if (T.size() < nT)  { return(2); };
if (N.size() < nT)  { return(2); };

// =========================================================================== //
// CHECK STREAM STATUS                                                         //
// =========================================================================== //
if (!file_handle.good()) { return(1); };

// ============================================================================ //
// WRITE STL SOLID                                                              //
// ============================================================================ //

// Solid header --------------------------------------------------------------- //
sheader << "solid " << solid_name;
header = sheader.str();
header = trim(header);
file_handle << header << endl;
sheader.str("");

// Loop over triangulation facet ---------------------------------------------- //
for (i = 0; i < nT; i++) {

    // facet normal
    file_handle << "  facet";
    n = N[i].size();
    if (n > 0) {
        file_handle << " normal ";
        for (j = 0; j < n-1; j++) {
            file_handle << scientific << N[i][j] << " ";
        } //next j
        file_handle << scientific << N[i][n-1];;
    }
    file_handle << endl;

    // facet vertices
    file_handle << "    outer loop" << endl;
    n = T[i].size();
    for (j = 0; j < n; j++) {
        m = V[T[i][j]].size();
        file_handle << "      vertex ";
        if (m > 0) {
            for (k = 0; k < m-1; k++) {
                file_handle << scientific << V[T[i][j]][k] << " ";
            } //next k
            file_handle << scientific << V[T[i][j]][m-1];
        }
        file_handle << endl;
    } //next j
    file_handle << "    endloop"    << endl;

    // facet - closing header
    file_handle << "  endfacet" << endl;

} //next i

// Closing header ------------------------------------------------------------- //
sheader << "endsolid " << solid_name;
header = sheader.str();
header = trim(header);
file_handle << header << endl;
sheader.str("");

return(0); };

// -------------------------------------------------------------------------- //
unsigned int Write_STLsolid_bin(
    ofstream                  &file_handle,
    int                       &nV,
    int                       &nT,
    dvector2D                 &V,
    dvector2D                 &N,
    ivector2D                 &T,
    string                     solid_name
) {

// ========================================================================== //
// unsigned int Write_STLsolid_bin(                                           //
//     ofstream                  &file_handle,                                //
//     int                       &nV,                                         //
//     int                       &nT,                                         //
//     dvector2D                 &V,                                          //
//     dvector2D                 &N,                                          //
//     ivector2D                 &T,                                          //
//     string                     solid_name)                                 //
//                                                                            //
// Export triangulation in a binary .stl file.                                //
// ========================================================================== //
// INPUT                                                                      //
// ========================================================================== //
// - file_handle : ofstream, output stream to binary stl file                 //
// - nV          : int, number of vertices in the stl triangulation           //
// - nT          : int, number of triangles in the stl triangulation          //
// - V           : dvector2D, vertex coordinate list. V[i][0], V[i][1], and   //
//                 V[i][2] are the x, y, z coordinates of the i-th vertex     //
// - N           : dvector2D, triangle unit normal. N[i][0], N[i][1], and     //
//                 N[i][2] are the x, y, z components of the unit normal to   //
//                 the i-th triangle in the stl triangulation                 //
// - T           : ivector2D, triangle-vertex connectivity. T[i][0], T[i][1], //
//                 and T[i][2] are the global indices of vertices of the i-th //
//                 triangle in the stl triangulation                          //
// ========================================================================== //
// OUTPUT                                                                     //
// ========================================================================== //
// - err         : int, output flag:                                          //
//                 err = 0      --> no errors encountered                     //
//                 err = 1      --> file is missing or cannot be accessed     //
//                 err = 2      --> stl solid is badly defined                //
// ========================================================================== //

// ========================================================================== //
// VARIABLES DECLARATION                                                      //
// ========================================================================== //

// Local variables
unsigned int       int2byte;
unsigned long int  longint4byte;
float              float4byte;
unsigned int      *int2byte_pointer = &int2byte;
unsigned long int *longint4byte_pointer = &longint4byte;
float             *float4byte_pointer = &float4byte;

// Counters
int                n, m, i, j, k;

// ============================================================================ //
// CHECK SOLID DEFINITION                                                       //
// ============================================================================ //
if (V.size() < nV)  { return(2); }
if (N.size() < nT)  { return(2); }
if (T.size() < nT)  { return(2); }

// ============================================================================ //
// CHECK STREAM STATUS                                                          //
// ============================================================================ //
if (!file_handle.good()) { return(1); }

// ============================================================================ //
// EXPORT DATA                                                                  //
// ============================================================================ //

// File header ---------------------------------------------------------------- //

// title
float4byte = (float)0.0;
for (i = 0; i < 20; i++) {
    file_handle.write(reinterpret_cast<char*>(float4byte_pointer), 4);
} //next i

// number of elements
longint4byte = (unsigned long int) nT;
file_handle.write(reinterpret_cast<char*>(longint4byte_pointer), 4);

// Loop over triangles -------------------------------------------------------- //
for (i = 0; i < nT; i++) {

    // Normals
    n = N[i].size();
    for (j = 0; j < n; j++) {
        float4byte = (float) N[i][j];
        file_handle.write(reinterpret_cast<char*>(float4byte_pointer), 4);
    } //next j

    // Vertex
    n = T[i].size();
    for (j = 0; j < n; j++) {
        m = V[T[i][j]].size();
        for (k = 0; k < m; k++) {
            float4byte = (float) V[T[i][j]][k];
            file_handle.write(reinterpret_cast<char*>(float4byte_pointer), 4);
        } //next k
    } //next j

    // Block closing header
    int2byte = 0;
    file_handle.write(reinterpret_cast<char*>(int2byte_pointer), 2);
} //next i

return(0); };


